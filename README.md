# nRF52840 Arduino 

ボードはSwicth ScienceのISP1807 Breakoutを使用。

ブートローダーはおそらくUF2？  
書き込みの際はResetを2度押しらしい。

消費電力的にはベアメタルの方が優位かもしれない。  
その場合は、USBが使えずSWD経由での書き込みとなるため、RaspberryPipicoでSWDデバッグができるpicoprobeとやらが使えそう。

## サンプルアプリ動作

I2Cでサーマルカメラ(MLX90640)のデータ取得後、BLEとSerialに出力する。  
上記を一周期として、BLE接続の有無に応じて下記の動作を行う。

- BLE接続した場合、1周期ごとに10秒System ON スリープを行う。
- BLE接続がない場合、スリープは行わない。

ちなみに、BLE->Serialへの繋ぎは生きている。

I2Cの配線は以下(variantファイル参照。)

SCL: p0_23  
SDA: p0_19

## Sleepについて

System OFF スリープ( `sd_power_system_off()` )は、システムを完全にリセットする。  

復帰方法は以下のみで、基本的には外部からの信号が必要になる。

> 1.The DETECT signal, optionally generated by the GPIO peripheral.
> 2.The ANADETECT signal, optionally generated by the LPCOMP module.
> 3.The SENSE signal, optionally generated by the NFC module to wake-on-field.
> 4.Detecting a valid USB voltage on the VBUS pin (V BUS,DETECT ).
> 5.A reset.

タイマーで復帰させる場合は、System ON スリープ( `sd_app_evt_wait()` )を実行する必要がある。  
消費電力がどの程度違うか検討した方がいいかもしれない。  
FPGAがFlashFreezeできるようになれば、そこからピン割り込みができるため、セントラル側（FPGAボードにつなぐ側）はシステムOFFできそう。

## 未対応ボード(ex.ISP1807 breakoutボード)をArduino + PlatformIOで使う

1. ベースに使えそうなボードを見つける

今回は、ブートローダーが(多分)共通のため、Adafruit fetherが使えそうだった。  
書き込みにも成功したが、おそらくピン配をカスタムする必要がある。  

2. ベースボードのvariantファイルを持ってくる。

platformのリポジトリ(nordicnrf52。platformioのドキュメントから飛べる)から、ボード設定のJSONファイルを開く。  
variants欄にvariantsの名前が記載されているので、該当ボードのArduinoプラットフォームのリポジトリに移動し、variantsを取得する。  
ArduinoIDEにすでに対応されているボードについては、それを持ってくるだけでよい


3. プロジェクト内にcustom variantを格納するディレクトリを作成し、platform.iniにて参照設定を行う

本リポジトリのiniファイルを参照。

パッケージ内の`variants`フォルダを強制参照するようなので、そこに格納すればよいらしい。  
NGな場合、 `variants_dir`の設定をiniに記述すればよい

[参考](https://github.com/maxgerhardt/pio-custom-stm32duino-variants)

## Zephyr RTOSで使う場合

https://piolabs.com/blog/engineering/platformio-zephyr-custom-hardware.html#adding-a-custom-board-to-zephyr

